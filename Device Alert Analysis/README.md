# Device Alert Analytics

This script retrieves **activities** from the NinjaOne Public API for a specified time window, filters to **CONDITION** activities with `statusCode = TRIGGERED`, and then calculates **per-device alert metrics** such as:

- Total number of condition triggers per device
- Top 10 most frequently triggered conditions per device (rendered as an HTML table)
- Device rank by trigger volume (relative to other alerting devices)
- A Day-of-Month × Month heatmap of triggers (rendered as HTML)
- The total number of devices in the environment that have a condition that has triggered over the past 30 days

The script will then **write these results back to each device as custom fields**.

## Prerequisites

- **API Server** See [the setup guide on getting started](https://docs.mspp.io/ninjaone-auto-documentation/getting-started) with an API server. The first part of [this video](https://www.youtube.com/watch?v=Qy9g6-KVfbo) walks through setting up an API server.
- **PowerShell:** 5.1+ (PowerShell 7 recommended)
- **NinjaOne:** OAuth app with Client Credentials flow and scopes `monitoring` and `management`

This uses the API server workflow described here: [Getting Started](https://docs.mspp.io/ninjaone-auto-documentation/getting-started). The first part of [this video](https://www.youtube.com/watch?v=Qy9g6-KVfbo) walks through setting up an API server if you haven't done it before.

## Required Custom Fields

Create the following **Device** custom fields with the listed permissions. You may rename these fields, but if you do, you must update the keys in `New-CustomFieldPayloadFromReport` accordingly.

| **API Name (Key)**            | **Display Name**              | **Permissions**                                                                 | **Scope** | **Type**   |
|------------------------------|-------------------------------|----------------------------------------------------------------------------------|-----------|------------|
| `totalConditionsTriggered`   | Total Conditions Triggered    | - Read-Only to Technicians<br>- Read-Only to Automations<br>- Read/Write to API | Device    | Integer    |
| `deviceAlertRank`            | Device Alert Rank             | - Read-Only to Technicians<br>- Read-Only to Automations<br>- Read/Write to API | Device    | Integer    |
| `totalAlertingDevices`       | Total Alerting Devices        | - Read-Only to Technicians<br>- Read-Only to Automations<br>- Read/Write to API | Device    | Integer    |
| `mostFrequentAlerts`         | Most Frequent Alerts (Top 10)  | - Read-Only to Technicians<br>- Read-Only to Automations<br>- Read/Write to API | Device    | WYSIWYG    |
| `alertHeatMap`               | Alert Heatmap                 | - Read-Only to Technicians<br>- Read-Only to Automations<br>- Read/Write to API | Device    | WYSIWYG    |

Assign these device custom fields to the devices (or policies) you want the report to populate.

### Notes

- The two WYSIWYG fields store **HTML** generated by the script:
  - `mostFrequentAlerts`: HTML table of the device's top 10 triggered conditions
  - `alertHeatMap`: HTML heatmap table (Day 1–31 × Month)
- The script warns if HTML output approaches NinjaOne WYSIWYG size limits (the helper checks ~200,000 characters).

## Configuration

Edit the script's config block (around lines 19–73) to match your environment.

## Outputs

- **`$DeviceReports`** — Per-device report objects: `deviceId`, `totalConditionsTriggered`, `top10Conditions`, `top10ConditionsTableText`, `rankAmongAlertingDevices`, `totalAlertingDevices`, `heatmapMonths`, `heatmapMatrix`, `heatmapHtml`.
- **`$GlobalSummary`** — Overall summary: `timeMinUtc`, `timeMaxUtc`, `totalTriggeredEvents`, `totalAlertingDevices`, `deviceRanks`.
- **Console** — Top 20 device ranks by trigger volume and an example top-10 conditions table.
- **Optional** — Commented-out examples for exporting CSV; one heatmap HTML file is written to the configured path.
- **Device custom fields** — Each device in the report is updated via PATCH to the custom fields listed in Required Custom Fields above.

### Disclaimer

This is a personal project provided as an educational example of how to interact with the NinjaOne API, and does not fall within the scope of NinjaOne support.
